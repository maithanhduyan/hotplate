# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Hotplate â€” Release Workflow
# Triggers on version tags (v0.1.0, v1.2.3, â€¦)
# 1. Build Rust binary for 4 platforms
# 2. Package VSIX with all binaries
# 3. Create GitHub Release with VSIX + standalone binaries
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: Release

on:
  push:
    tags:
      - "v*"   # e.g. v0.1.0, v1.0.0-beta
  workflow_dispatch:   # allow manual trigger for testing

permissions:
  contents: write      # needed to create GitHub Releases

env:
  CARGO_TERM_COLOR: always

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Build Rust binary per platform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build â€” ${{ matrix.label }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary: hotplate-win32-x64.exe
            label: Windows x64

          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary: hotplate-linux-x64
            label: Linux x64

          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            binary: hotplate-linux-arm64
            label: Linux ARM64
            cross: true

          - os: macos-latest
            target: aarch64-apple-darwin
            binary: hotplate-darwin-arm64
            label: macOS ARM64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # Linux ARM64 needs cross-compilation toolchain
      - name: Install cross-compile tools (Linux ARM64)
        if: matrix.cross
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++" >> $GITHUB_ENV

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      # Copy the exact binary (not wildcard) to a known location
      - name: Prepare binary (Unix)
        if: runner.os != 'Windows'
        run: |
          cp target/${{ matrix.target }}/release/hotplate ${{ matrix.binary }}
          chmod +x ${{ matrix.binary }}

      - name: Prepare binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Copy-Item "target/${{ matrix.target }}/release/hotplate.exe" "${{ matrix.binary }}"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary }}
          path: ${{ matrix.binary }}
          retention-days: 1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Package VSIX + Create Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: Package & Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Download all platform binaries into vscode-extension/bin/
      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: vscode-extension/bin/

      # download-artifact creates subdirectories per artifact name â€” flatten them
      - name: Flatten bin directory
        run: |
          cd vscode-extension/bin
          find . -mindepth 2 -type f -exec mv {} . \;
          find . -mindepth 1 -type d -exec rmdir {} + 2>/dev/null || true
          echo "â”€â”€ bin/ contents â”€â”€"
          ls -la
          echo "â”€â”€ Verify all 4 binaries exist â”€â”€"
          test -f hotplate-win32-x64.exe  || { echo "âŒ Missing Windows binary"; exit 1; }
          test -f hotplate-linux-x64      || { echo "âŒ Missing Linux x64 binary"; exit 1; }
          test -f hotplate-linux-arm64    || { echo "âŒ Missing Linux ARM64 binary"; exit 1; }
          test -f hotplate-darwin-arm64   || { echo "âŒ Missing macOS binary"; exit 1; }
          chmod +x hotplate-linux-* hotplate-darwin-*
          echo "âœ… All binaries present"

      # Build VSIX
      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Package VSIX
        run: |
          cd vscode-extension
          vsce package --skip-license
          echo "â”€â”€ VSIX â”€â”€"
          ls -la *.vsix

      # Extract version from tag
      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      # Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Hotplate v${{ steps.version.outputs.version }}"
          body: |
            ## ðŸ”¥ Hotplate v${{ steps.version.outputs.version }}

            ### Installation
            - **VS Code**: Download the `.vsix` file â†’ `Extensions` â†’ `...` â†’ `Install from VSIX`
            - **Standalone**: Download the binary for your platform and run `hotplate --help`

            ### Binaries
            | Platform | File |
            |----------|------|
            | Windows x64 | `hotplate-win32-x64.exe` |
            | Linux x64 | `hotplate-linux-x64` |
            | Linux ARM64 | `hotplate-linux-arm64` |
            | macOS ARM64 | `hotplate-darwin-arm64` |
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          files: |
            vscode-extension/*.vsix
            vscode-extension/bin/hotplate-win32-x64.exe
            vscode-extension/bin/hotplate-linux-x64
            vscode-extension/bin/hotplate-linux-arm64
            vscode-extension/bin/hotplate-darwin-arm64
